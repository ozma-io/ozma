services:
  web:
    build: 
      context: .
      dockerfile: docker/Dockerfile.heroku
    environment:
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - EXTERNAL_ORIGIN=https://${HEROKU_APP_NAME}.herokuapp.com
      - CADDY_ADDRESS=${HEROKU_APP_NAME}.herokuapp.com
      - DATABASE_URL=${DATABASE_URL}
      - PORT=${PORT}
    ports:
      - "${PORT}:${PORT}"
    depends_on:
      - keycloak
      - ozmadb
      - ozma-report-generator
    deploy:
      resources:
        limits:
          memory: 512M

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_DB=postgres
      - KC_DB_URL=${DATABASE_URL}
      - KC_HOSTNAME_STRICT=false
      - KC_PROXY=edge
    command: ["start", "--optimized"]
    deploy:
      resources:
        limits:
          memory: 512M

  ozmadb:
    image: ozmaio/ozmadb:master
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH_AUTHORITY=https://${HEROKU_APP_NAME}.herokuapp.com/auth/realms/ozma
      - AUTH_METADATA_ADDRESS=http://keycloak:8080/auth/realms/ozma/.well-known/openid-configuration
      - AUTH_REQUIRE_HTTPS_METADATA=false
    deploy:
      resources:
        limits:
          memory: 256M

  ozma-report-generator:
    image: ozmaio/ozma-report-generator:master
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH_CLIENT_ID=ozma-report-generator
      - ORIGIN=https://${HEROKU_APP_NAME}.herokuapp.com
      - PATH_BASE=/report-generator
      - OZMA_DB_URL=http://ozmadb:5000
      - AUTH_AUTHORITY=https://${HEROKU_APP_NAME}.herokuapp.com/auth/realms/ozma
      - AUTH_METADATA_ADDRESS=http://keycloak:8080/auth/realms/ozma/.well-known/openid-configuration
      - AUTH_REQUIRE_HTTPS_METADATA=false
    deploy:
      resources:
        limits:
          memory: 512M 
